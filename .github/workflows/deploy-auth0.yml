name: Deploy Universal Login to Auth0

on:
  push:
    branches:
      - main  # Cambia la rama si usas otra para despliegues

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Install dependencies
        run: |
          sudo apt-get install curl jq

      - name: Authenticate with Auth0
        run: |
          # Obtén un token de acceso desde la API de Auth0
          AUTH0_DOMAIN="aqua-turtle-96296.cic-demo-platform.auth0app.com"
          CLIENT_ID="${{ secrets.AUTH0_CLIENT_ID }}"
          CLIENT_SECRET="${{ secrets.AUTH0_CLIENT_SECRET }}"
          
          RESPONSE=$(curl --request POST \
            --url "https://${AUTH0_DOMAIN}/oauth/token" \
            --header 'content-type: application/json' \
            --data "{\"client_id\":\"${CLIENT_ID}\",\"client_secret\":\"${CLIENT_SECRET}\",\"audience\":\"https://${AUTH0_DOMAIN}/api/v2/\",\"grant_type\":\"client_credentials\"}")

          ACCESS_TOKEN=$(echo $RESPONSE | jq -r .access_token)

      - name: Update Universal Login Template
        run: |
          # Aquí se hace el update del Universal Login usando la Auth0 Management API
          TEMPLATE_FILE="templates/universal-login.html"
          curl --request PUT \
            --url "https://${AUTH0_DOMAIN}/api/v2/branding/templates/universal-login" \
            --header "authorization: Bearer $ACCESS_TOKEN" \
            --header 'content-type: application/json' \
            --data @${TEMPLATE_FILE}
